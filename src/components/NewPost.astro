---
// NewPost.astro
---

<section class="p-4">
  <button id="newPostBtn" class="btn btn-primary">New Post</button>

  <form id="postForm" class="hidden mt-4 space-y-4" method="POST">
    <input type="hidden" id="pid" name="pid">
    <input type="hidden" id="uid" name="uid">

    <label class="form-control">
      <span class="label-text">Caption</span>
      <input type="text" id="caption" name="caption" class="input input-bordered" required>
    </label>

    <label class="form-control">
      <span class="label-text">Upload Image</span>
      <input type="file" id="imageInput" accept="image/*" class="file-input file-input-bordered" required>
    </label>

    <button type="submit" class="btn btn-success">Post</button>
  </form>

  <script type="module">    
    const cloud_name = import.meta.env.CLOUDINARY_CLOUD_NAME;
    console.log("(NewPost.astro) cloud_name: ",cloud_name);
    const upload_preset = import.meta.env.CLOUDINARY_UPLOAD_PRESET;
    console.log("(NewPost.astro) upload_preset: ",upload_preset);

    const newPostBtn = document.getElementById('newPostBtn');
    const postForm = document.getElementById('postForm');
    const pidInput = document.getElementById('pid');
    const uidInput = document.getElementById('uid');
    const imageInput = document.getElementById('imageInput');
    const captionInput = document.getElementById('caption');

    const uid = document.querySelector('meta[name="user-id"]')?.content || "unknown-user";
    console.log("(NewPost.astro) uid: ", uid);

    newPostBtn.addEventListener('click', () => {
      postForm.classList.toggle('hidden');
      pidInput.value = crypto.randomUUID();
      uidInput.value = uid;
    });

    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = await imageInput.files[0];
      if (!file) return alert("Please select an image.");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", upload_preset);

      const cloudRes = await fetch(`https://api.cloudinary.com/v1_1/${cloud_name}/image/upload`, { 
        method: "POST",
        body: formData
      });

      const cloudData = await cloudRes.json();
      console.log("(NewPost.astro) cloudData: ", cloudData);
      const imageUrl = cloudData.secure_url;
      console.log("(NewPost.astro) imageUrl: ", imageUrl);

      const payload = {
        pid: pidInput.value,
        uid: uidInput.value,
        caption: captionInput.value,
        url: imageUrl
      };
      console.log("(NewPost.astro) payload: ", payload)

      const postRes = await fetch('/.netlify/functions/createPost', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (postRes.ok) {
        alert("Post created!");
        postForm.reset();
        postForm.classList.add('hidden');
      } else {
        const err = await postRes.json();
        alert("Failed to create post: " + err?.error || "Unknown error");
      }
    });
  </script>
</section>
