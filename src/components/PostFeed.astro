---
import EditPost from "./EditPost.astro";
import CommentList from "./CommentList.astro";
import NewComment from "./NewComment.astro";
import DeletePost from "./DeletePost.astro";
import Reaction from "./Reaction.astro";
const res = await fetch('https://cscd488group3-bloombuddy.netlify.app/.netlify/functions/getPosts'); // Adjust to your Netlify Function URL
const result = await res.json();

// Ensure it's an array
const posts = Array.isArray(result) ? result : result?.data ?? [];
---

<div id="postContainer">
  {posts.map(post => (
    <div class="post">
      <figure class="post">
        <img src={post.url} alt="Post Image" class="w-full" />
      </figure>
      <div class="card-body">
        <h2 class="card-title">{post.caption}</h2>
        <p class="text-sm text-black-100">- {post.uid}</p>
        <details>
          <summary class="question text-sm text-black-100 hidden">Edit or Delete your Post</summary>
          <div class="flex flex-row items-center gap-4 h-auto">
            <EditPost pid={post.pid} class="h-full"/>
            <DeletePost pid={post.pid} class="h-full"/>
          </div>
        </details>

        {/* <!-- Reactions Placeholder -->
        <div class="mt-2">
          <Reaction pid={post.pid}/>
        </div> */}

        <!-- Comments -->
        <details class="mt-0">
          <summary class="question text-sm text-black-100">View Comments</summary>
          <CommentList pid={post.pid} />
          <details>
            <summary class="question text-sm text-black-100">Add a Comment</summary>
            <NewComment pid={post.pid}/>
          </details>
        </details>
      </div>
    </div>

    // check if the current user and the 
    // author of the post are the same user
    // if so, reveal the form to edit or delete posts
    <script type="module">
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('summary').forEach(summary => {
          const uid = document.querySelector('meta[name="user-id"]')?.content || "unknown-user";;
          const author = post.uid;
          if (uid === author) {
            summary.classList.remove('hidden');
          }
        });
      });
    </script>
  ))}
</div>


