---
const { pid } = Astro.props;
const res = await fetch(`https://cscd488group3-bloombuddy.netlify.app/.netlify/functions/getComments?pid=${pid}`);
const result = await res.json();

const comments = Array.isArray(result) ? result : result?.data ?? [];
---

<div class="mt-0 space-y-0">
  {comments.map(comment => (
    <div class="comment text-sm" data-uid={comment.uid} data-cid={comment.cid}>
      <p>{comment.content}</p>
      <p class="text-xs">
        â€” {comment.uid}
        <button class="edit-comment-btn bg-green-500 hover:bg-green-700 text-black font-bold py-2 px-4 rounded-full hidden">Edit</button>
        <button class="delete-comment-btn bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full hidden">Delete</button>
      </p>
    </div>
  ))}
</div>

<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const currentUser = document.querySelector('meta[name="user-id"]')?.content;

    document.querySelectorAll('[data-uid]').forEach(commentEl => {
      const commentAuthor = commentEl.dataset.uid;
      if (commentAuthor === currentUser) {
        commentEl.querySelector('.edit-comment-btn')?.classList.remove('hidden');
        commentEl.querySelector('.delete-comment-btn')?.classList.remove('hidden');
      }
    });
  });
</script>
